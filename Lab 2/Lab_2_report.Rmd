---
title: "Lab 2 - TDDE07"
author: "Axel Holmberg (axeho681), Wilhelm Hansson (wilha431)"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

## 1.

### a)
```{r}
setwd("~/Programming/TDDE07/Lab 2")
library(ggplot2)
data <-
	read.delim("TempLinkoping.txt",
						 header = TRUE,
						 sep = "\t",
						 dec = ".")

library(LaplacesDemon)
library(mvtnorm)
set.seed(12345)
my_0 <- matrix(c(-10, 130, -130), nrow = 3, ncol = 1)

omega_0 <- 3 * diag(3)

v_0 <- 10
sigma_sq_0 <- 2

number_of_draws <- 100

sigma_sq <- rinvchisq(number_of_draws, v_0, sigma_sq_0)

omega_0.inv <- solve(omega_0)


betas <- c()


for (sigma in sigma_sq) {
	beta <- rmvnorm(1, my_0, sigma * omega_0.inv)
	#tmp <- cbind(sigma, beta)
	betas <- rbind(betas, beta)
}


linear_matrix <- c()

times <- seq(0, 1, 0.01)
for (rownumber in 1:nrow(betas)) {
	tmprow <- c()
	for (time in times) {
		tmp <- betas[rownumber, 1] + betas[rownumber, 2] * time + betas[rownumber, 3] *
			time ^ 2
		tmprow <- cbind(tmprow, tmp)
	}
	linear_matrix <- rbind(linear_matrix, tmprow)
}

plot(times,linear_matrix[1,], type='l', ylim=c(-20,30))
for (i in 2:nrow(linear_matrix)) {
	lines(times, linear_matrix[i,])
	
}

```

The plot above shows the regression curve for the temperature. The tuning of the joint prior parameters was decided by looking at the values of the actual data. From the data the mean, min and max values were identified. Further the knowledge that 0 = January and 1 = December was used to unnderstand when the peak of the quadratic curve wsa suppose to be (around 0.5 ~ June). So, variance between the individual curves were allowed to avoid to much bias.




```{r}

X <- cbind(rep.int(1, 365), data[, 1], I(data[, 1] ^ 2))
Y <- data[, 2]

beta_hat <- solve((t(X) %*% X)) %*% t(X) %*% Y
my_n <-
	solve(t(X) %*% X + omega_0) %*% (t(X) %*% X %*% beta_hat + omega_0 %*% my_0)
omega_n <- t(X) %*% X + omega_0
v_n <- v_0 + nrow(X)
v_n_sigma_sq_n <-
	v_0 * sigma_sq_0 + (t(Y) %*% Y + t(my_0) %*% omega_0 %*% my_0 - t(my_n) %*%
												omega_n %*% my_n)
n_draws <- 100

sigmas_sq <- rinvchisq(n_draws, v_n, v_n_sigma_sq_n / v_n)
hist(sqrt(sigmas_sq))


betas_posterior <- c()
for (sigma_sq in sigmas_sq) {
	beta_posterior <- rmvnorm(1, my_n, sigma_sq * solve(omega_n))
	betas_posterior <- rbind(betas_posterior, beta_posterior)
}

hist(betas_posterior[, 1], xlab = "B0 (intercept)")
hist(betas_posterior[, 2], xlab = "B1 (slope)")
hist(betas_posterior[, 3], xlab = "B2 (curve)")

calctemp <- function(x) {
	return(
		median(betas_posterior[, 1]) + median(betas_posterior[, 2]) * x + median(betas_posterior[, 3]) *
			x ^ 2
	)
}



conf_i <- function(betas) {
	tmp <- sort(betas)
	tmp_cols <- cbind(tmp[,0.025 * nrow(betas)], tmp[,0.975 * nrow(betas)])
	return(tmp_cols)
}

out <- c()
for (time in data$time) {
	ys <- c()
	for (i in 1:10) { #INCREASE
		betas_posterior_tmp <- c()
		for (sigma_sq in sigmas_sq) {
			beta_posterior_tmp <- rmvnorm(1, my_n, sigma_sq * solve(omega_n))
			betas_posterior_tmp <-
				rbind(betas_posterior_tmp, beta_posterior_tmp)
		}
		
		b0m_tmp <- median(betas_posterior_tmp[, 1])
		b1m_tmp <- median(betas_posterior_tmp[, 2])
		b2m_tmp <- median(betas_posterior_tmp[, 3])
		
		y <-  b0m_tmp + b1m_tmp * time + b2m_tmp * time ^ 2
		ys <- cbind(ys, y)
	}

	out <- rbind(out,ys)
	
}

cis <- c()
for (i in 1:nrow(data)) { 
	ci_tmp <- CI(out[i,])
	cis <- rbind(cis,cbind(ci_tmp[1],median(out[i,]),ci_tmp[3]))
	
}

ggplot() + geom_point(aes(x=data$time,y=data$temp)) + geom_line(aes(x=data$time,y=cis[,2])) + geom_line(aes(x=data$time,y=cis[,1],color="upper")) + geom_line(aes(x=data$time,y=cis[,3],color="lower"))

```



```{r}

x_tilde <- data$time[which(max(line) == line)]

```


```{r}



```